<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Rastreo Profesional</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      #map {
        height: calc(100vh - 80px);
        width: 100%;
        border-radius: 1rem;
        z-index: 1;
      }
      .pulse-searching {
        animation: pulse-blue 2s infinite;
      }
      @keyframes pulse-blue {
        0% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }
        70% {
          box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
      }
    </style>
  </head>
  <body class="bg-slate-950 text-slate-200 font-sans overflow-hidden">
    <header
      class="h-20 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 px-8 flex justify-between items-center z-50 relative"
    >
      <div class="flex items-center gap-3">
        <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-900/20">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 text-white"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
            />
          </svg>
        </div>
        <h1 class="text-xl font-black tracking-tight uppercase">
          Tracker <span class="text-blue-500 font-black">Pro</span>
        </h1>
      </div>
      <div
        id="badge"
        class="px-4 py-1.5 bg-slate-800 rounded-full text-[10px] font-bold uppercase tracking-widest border border-slate-700"
      >
        Sistema en LÃ­nea
      </div>
    </header>

    <main class="flex h-[calc(100vh-80px)] p-6 gap-6">
      <aside class="w-80 flex flex-col gap-6">
        <div
          class="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-2xl"
        >
          <label
            class="text-[10px] font-black text-slate-500 uppercase mb-4 block"
            >Dispositivo Seleccionado</label
          >
          <div class="flex gap-2">
            <select
              id="deviceSelect"
              class="flex-1 bg-black border border-slate-700 rounded-xl p-3 text-sm text-white outline-none"
            >
              <option value="">Cargando...</option>
            </select>
            <button
              onclick="cargarDispositivos()"
              class="p-3 bg-slate-800 hover:bg-slate-700 rounded-xl"
            >
              ðŸ”„
            </button>
          </div>
          <button
            id="btnLocate"
            onclick="solicitarUbicacion()"
            class="mt-4 w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-black uppercase text-xs tracking-widest transition-all"
          >
            Localizar Ahora
          </button>
        </div>

        <div
          class="bg-slate-900 p-6 rounded-3xl border border-slate-800 flex-1 flex flex-col shadow-2xl"
        >
          <h3
            class="text-xs font-black uppercase text-blue-500 mb-6 tracking-widest flex items-center gap-2"
          >
            <span
              id="telemetryDot"
              class="w-2 h-2 bg-blue-500 rounded-full"
            ></span>
            Estado del GPS
          </h3>
          <div class="space-y-6">
            <div>
              <span class="text-[10px] text-slate-500 uppercase font-bold"
                >Fuente</span
              >
              <div id="provText" class="text-sm font-bold text-slate-400">
                Esperando...
              </div>
            </div>
            <div>
              <span class="text-[10px] text-slate-500 uppercase font-bold"
                >PrecisiÃ³n</span
              >
              <div id="accText" class="text-lg font-mono text-blue-400">-</div>
            </div>
          </div>
          <div class="mt-auto pt-4 border-t border-slate-800">
            <div
              id="logContainer"
              class="bg-black/50 p-4 rounded-xl text-[9px] font-mono text-slate-600 h-32 overflow-y-auto"
            >
              > Iniciando sistema...
            </div>
          </div>
        </div>
      </aside>

      <section
        id="mapWrapper"
        class="flex-1 bg-slate-900 rounded-3xl border border-slate-800 overflow-hidden relative shadow-2xl"
      >
        <div id="map"></div>
      </section>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      let map = L.map("map", { center: [-12.046, -77.042], zoom: 13 });
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      ).addTo(map);

      let marker, circle, pollInterval;

      window.onload = cargarDispositivos;

      function addLog(msg, isError = false) {
        const container = document.getElementById("logContainer");
        container.innerHTML =
          `<div class="${isError ? "text-red-400" : "text-slate-500"}">[${new Date().toLocaleTimeString()}] ${msg}</div>` +
          container.innerHTML;
      }

      async function cargarDispositivos() {
        try {
          const res = await fetch("/api/devices");
          const devices = await res.json();
          const select = document.getElementById("deviceSelect");
          select.innerHTML = '<option value="">-- Elige --</option>';
          devices.forEach((dev) => {
            const opt = document.createElement("option");
            opt.value = dev.token;
            opt.text = dev.deviceId;
            select.appendChild(opt);
          });
          addLog("Dispositivos sincronizados");
        } catch (e) {
          addLog("Error de base de datos", true);
        }
      }

      async function solicitarUbicacion() {
        const token = document.getElementById("deviceSelect").value;
        if (!token) return alert("Selecciona un dispositivo");

        const btn = document.getElementById("btnLocate");
        btn.disabled = true;
        btn.innerText = "CONECTANDO...";
        btn.className =
          "mt-4 w-full bg-slate-700 text-white py-4 rounded-xl font-black uppercase text-xs";

        document.getElementById("mapWrapper").classList.add("pulse-searching");
        document.getElementById("telemetryDot").classList.add("animate-ping");

        addLog(`Iniciando bÃºsqueda de 30 segundos...`);

        // 1. Iniciamos el cronÃ³metro de inmediato (sin esperar al servidor)
        iniciarEscucha();

        // 2. Enviamos la seÃ±al al servidor (en paralelo)
        try {
          const response = await fetch("/api/request-location", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ deviceToken: token }),
          });

          if (response.ok) {
            addLog("SeÃ±al de rastreo enviada con Ã©xito.");
            btn.innerText = "ESPERANDO GPS...";
          } else {
            const errorData = await response.json();
            finalizarConError("Fallo en servidor: " + errorData.error);
          }
        } catch (e) {
          finalizarConError("No hay conexiÃ³n con Render.");
        }
      }

      function iniciarEscucha() {
        if (pollInterval) clearInterval(pollInterval);
        let segundos = 0;
        const maxSegundos = 30;

        pollInterval = setInterval(async () => {
          segundos += 2;
          addLog(`Buscando... ${segundos}s`);

          try {
            const res = await fetch("/api/get-status");
            const data = await res.json();

            if (data.status === "OK") {
              clearInterval(pollInterval);
              actualizarInterfaz(data);
            } else if (segundos >= maxSegundos) {
              clearInterval(pollInterval);
              finalizarConError("Tiempo agotado. El celular no respondiÃ³.");
            }
          } catch (e) {
            console.error(e);
          }
        }, 2000);
      }

      function finalizarConError(msg) {
        clearInterval(pollInterval);
        addLog(msg, true);
        const btn = document.getElementById("btnLocate");
        btn.disabled = false;
        btn.innerText = "REINTENTAR";
        btn.className =
          "mt-4 w-full bg-red-600 text-white py-4 rounded-xl font-black uppercase text-xs";
        document
          .getElementById("mapWrapper")
          .classList.remove("pulse-searching");
        document
          .getElementById("telemetryDot")
          .classList.remove("animate-ping");
      }

      function actualizarInterfaz(data) {
        const pos = [data.lat, data.lng];
        if (marker) map.removeLayer(marker);
        if (circle) map.removeLayer(circle);

        circle = L.circle(pos, {
          radius: data.accuracy,
          color: "#3b82f6",
          weight: 1,
          fillOpacity: 0.15,
        }).addTo(map);
        marker = L.marker(pos).addTo(map);
        map.flyTo(pos, 18);

        document.getElementById("provText").innerText = (
          data.provider || "red"
        ).toUpperCase();
        document.getElementById("accText").innerText =
          `Â± ${data.accuracy.toFixed(1)} m`;

        const btn = document.getElementById("btnLocate");
        btn.disabled = false;
        btn.innerText = "LOCALIZAR AHORA";
        btn.className =
          "mt-4 w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs";
        document
          .getElementById("mapWrapper")
          .classList.remove("pulse-searching");
        document
          .getElementById("telemetryDot")
          .classList.remove("animate-ping");
        addLog("âœ… UBICACIÃ“N RECIBIDA");
      }
    </script>
  </body>
</html>

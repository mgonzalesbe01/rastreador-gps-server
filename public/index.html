<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Panel de Rastreo - Google Maps Edition</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      #map {
        height: calc(100vh - 100px);
        width: 100%;
        border-radius: 1.5rem;
        z-index: 1;
      }
      .leaflet-control-layers {
        border-radius: 12px !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
        padding: 5px !important;
      }
    </style>
  </head>
  <body class="bg-[#1a1b1e] text-white p-6 font-sans">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-6">
      <!-- Barra Lateral de Control -->
      <aside class="w-full md:w-80 space-y-4">
        <div
          class="bg-[#2c2d31] p-6 rounded-2xl border border-gray-800 shadow-xl"
        >
          <div class="flex items-center gap-2 mb-6">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            <h2
              class="text-xs font-black uppercase tracking-widest text-gray-400"
            >
              Sistema en Vivo
            </h2>
          </div>

          <label
            class="text-[10px] font-bold uppercase text-blue-400 mb-2 block"
            >Dispositivo</label
          >
          <select
            id="deviceSelect"
            class="w-full bg-black/50 p-3 rounded-xl text-sm border border-gray-700 mb-4 outline-none focus:border-blue-500 transition-all text-white"
          >
            <option>Buscando dispositivos...</option>
          </select>

          <button
            id="btnLocate"
            onclick="solicitar()"
            class="w-full bg-blue-600 p-4 rounded-xl font-black text-xs tracking-tighter hover:bg-blue-500 active:scale-95 transition-all shadow-lg shadow-blue-900/20"
          >
            ACTUALIZAR UBICACIÓN
          </button>
        </div>

        <div
          class="bg-[#2c2d31] p-6 rounded-2xl border border-gray-800 shadow-xl flex-1"
        >
          <h3
            class="text-[10px] font-bold uppercase text-gray-500 mb-4 tracking-widest text-center italic"
          >
            Consola de Eventos
          </h3>
          <div
            id="log"
            class="bg-black/40 p-4 rounded-xl h-60 overflow-y-auto font-mono text-[10px] text-gray-400 border border-gray-800 leading-relaxed"
          >
            > Esperando conexión...
          </div>
        </div>
      </aside>

      <!-- Contenedor del Mapa -->
      <div
        class="flex-1 bg-[#2c2d31] rounded-[2rem] p-2 border border-gray-800 shadow-2xl relative"
      >
        <div id="map"></div>

        <!-- Indicador de Precisión Flotante -->
        <div
          id="accuracyBadge"
          class="absolute bottom-8 left-8 z-[1000] bg-black/80 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 text-[10px] font-bold hidden"
        >
          PRECISIÓN: <span id="accVal" class="text-blue-400">-</span>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // CAPAS DE GOOGLE MAPS
      const googleStreets = L.tileLayer(
        "https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",
        {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "Google Maps",
        },
      );

      const googleHybrid = L.tileLayer(
        "https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
        {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "Google Maps Satellite",
        },
      );

      const googleTerrain = L.tileLayer(
        "https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}",
        {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "Google Maps Terrain",
        },
      );

      // Inicializar Mapa (Por defecto en Híbrido para ver calles sobre satélite)
      let map = L.map("map", {
        center: [-12.04, -77.04],
        zoom: 13,
        layers: [googleHybrid],
      });

      // Selector de Capas
      const baseMaps = {
        "Google Calles (Nombres)": googleStreets,
        "Google Satélite (Híbrido)": googleHybrid,
        "Google Terreno": googleTerrain,
      };
      L.control.layers(baseMaps).addTo(map);

      let marker, circle, poll;

      async function cargar() {
        try {
          const res = await fetch("/api/devices");
          const data = await res.json();
          const sel = document.getElementById("deviceSelect");
          if (data.length > 0) {
            sel.innerHTML = data
              .map((d) => `<option value="${d.token}">${d.deviceId}</option>`)
              .join("");
            addLog(`Detectado: ${data[0].deviceId}`);
          } else {
            sel.innerHTML = `<option>Sin dispositivos</option>`;
          }
        } catch (e) {
          addLog("Error cargando lista", true);
        }
      }
      window.onload = cargar;

      function addLog(m, err = false) {
        const l = document.getElementById("log");
        l.innerHTML =
          `<div class="${err ? "text-red-500" : ""} border-b border-white/5 py-1"><span>${new Date().toLocaleTimeString()}</span> ${m}</div>` +
          l.innerHTML;
      }

      async function solicitar() {
        const token = document.getElementById("deviceSelect").value;
        if (!token || token === "Sin dispositivos") return;

        addLog("Enviando comando de rastreo...");
        const btn = document.getElementById("btnLocate");
        btn.disabled = true;
        btn.innerText = "SOLICITANDO...";

        try {
          const res = await fetch("/api/request-location", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ deviceToken: token }),
          });
          if (res.ok) {
            addLog("Comando enviado. Esperando respuesta GPS...");
            escuchar();
          } else {
            addLog("Error al contactar servidor", true);
            btn.disabled = false;
            btn.innerText = "REINTENTAR";
          }
        } catch (e) {
          addLog("Error de conexión", true);
          btn.disabled = false;
        }
      }

      function escuchar() {
        let i = 0;
        if (poll) clearInterval(poll);
        poll = setInterval(async () => {
          i++;
          const res = await fetch("/api/get-status");
          const data = await res.json();

          if (data.status === "OK") {
            clearInterval(poll);
            const btn = document.getElementById("btnLocate");
            btn.disabled = false;
            btn.innerText = "ACTUALIZAR UBICACIÓN";

            addLog(`✅ Ubicación real recibida (${data.provider})`);

            const pos = [data.lat, data.lng];
            document.getElementById("accuracyBadge").style.display = "block";
            document.getElementById("accVal").innerText =
              `${data.accuracy.toFixed(1)} m`;

            if (marker) map.removeLayer(marker);
            if (circle) map.removeLayer(circle);

            circle = L.circle(pos, {
              radius: data.accuracy,
              color: "#3b82f6",
              weight: 1,
              fillOpacity: 0.1,
            }).addTo(map);
            marker = L.marker(pos).addTo(map);
            map.flyTo(pos, 18);
          } else if (data.status === "ERROR") {
            clearInterval(poll);
            addLog(`❌ ERROR: ${data.message}`, true);
            const btn = document.getElementById("btnLocate");
            btn.disabled = false;
            btn.innerText = "REINTENTAR";
          } else if (i > 20) {
            clearInterval(poll);
            addLog("❌ Tiempo agotado. Sin respuesta.", true);
            const btn = document.getElementById("btnLocate");
            btn.disabled = false;
            btn.innerText = "REINTENTAR";
          }
        }, 2000);
      }
    </script>
  </body>
</html>
